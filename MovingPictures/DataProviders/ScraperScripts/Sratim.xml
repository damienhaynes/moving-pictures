<ScriptableScraper>
  <details>
    <!-- These details are for display purposes only. -->
    <name>sratim.co.il</name>
    <author>erezr</author>
    <description>This script pulls data from sratim.co.il.</description>
    
    <!-- 
    These fields uniquely identify the script. The ID should never 
    change and should be unique (no other script should use this ID). With
    new versions of the script the version numbers should change. EVEN FOR 
    MINOR CHANGES, you should change the version number if you are going to
    disribute it to anyone but internal testers. The point number 
    is for minor bug fix releases. Use it.
    -->
    <id>439321</id>
    <version major="1" minor="0" point="5"/>
    <published month="2" day="23" year="2010"/>
    
    <!--
    These fields are used for categorization purposes. Seperate multiple 
    types with a pipe | character.
    -->
    <type>MovieDetailsFetcher|MovieCoverFetcher</type>
    <language>he</language>

   </details>
  
  
  <action name="search">
    
    <set name="offset" value="0" />
    
    <!-- Regular Expressions -->
	
	<set name="rx_search_results">
      <![CDATA[
      \s<a href="/movies/view\.aspx\?id=(\d+)">(.*?)</a> \((\d{4})\).+?<div.+?><a href="/movies/view.aspx\?id=\d+?">(.+?)</a></div>
      ]]>
    </set>
	

    <!-- Retrieve results using Title -->
    
    <retrieve name="search_page" url="http://www.sratim.co.il/movies/search.aspx?keywords=${search.title:safe}" />
    
    <!-- Search result page is used. -->

    <parse name="movie_details" input="${search_page}" regex="${rx_search_results}" />
    <loop name='curr_details' on='movie_details'>
      <add name="counter" value1="${count}" value2="${offset}" />
      <set name="movie[${counter}].site_id" value="${curr_details[0]:htmldecode}"/>
      <set name="movie[${counter}].title" value="${curr_details[3]:htmldecode}"/>
      <set name="movie[${counter}].year" value="${curr_details[2]:htmldecode}"/>
      <set name="movie[${counter}].details_url" value="http://www.sratim.co.il/movies/view.aspx?id=${curr_details[0]}"/>
    </loop>
	  
  </action>


  <action name="get_details">
  
    <!-- Regular Expressions -->
	
	<set name="rx_title">
      <![CDATA[
	  <title>(.*)-(.*)</title>
      ]]>
    </set>

	<set name="rx_year">
      <![CDATA[
      <span id="ctl00_ctl00_Body_Body_Box_ProductionYear">(\d{4})</span>
      ]]>
    </set>
	
    <set name="rx_directors_block">
      <![CDATA[
      <a href="/movies/search.aspx\?c=\d+">.*?</a>.*?<b>.*?</b>(.*?)<b>
      ]]>
    </set>
	
    <set name="rx_director">
      <![CDATA[
      <a href="/movies/actors/view.aspx\?id=\d{1,}">(.+?)</a>
      ]]>
    </set>
	
	<set name="rx_actors_block">
      <![CDATA[
      <b>.......</b>(.*)<a href="/movies/companies/view.aspx\?id=\d{1,}">
      ]]>
    </set>
	
	<set name="rx_actor">
      <![CDATA[
      <a href="/movies/actors/view.aspx\?id=\d{1,}">(.+?)</a>
      ]]>
    </set>
	
	<set name="rx_genres">
      <![CDATA[
      <a href="/movies/search.aspx\?g=(\d{1,})">(.+?)</a>
      ]]>
    </set>

	<set name="rx_imdb_id">
      <![CDATA[
	  <a href="/url.aspx\?http://www.imdb.com/title/(tt\d{1,})">
      ]]>
	</set>

	<set name="rx_languages">
      <![CDATA[
      <a href="/movies/search.aspx\?l=(\d{1,})">(.+?)</a>
      ]]>
    </set>
    
    <set name="rx_plot_block">
      <![CDATA[
      <b><u>.+?</u></b><br[\s]?/((><div[\s]dir="ltr")|)(.+?)/div>
      ]]>
    </set>
	
	<set name="rx_plot">
      <![CDATA[
      >(.*?)<
      ]]>
    </set>
	
    
    <retrieve name="details_page" url="http://www.sratim.co.il/movies/view.aspx?id=${movie.site_id}"/>
	
	<!--for imdb data -->
	<parse name="imdb_id" input="${details_page}" regex="${rx_imdb_id}"/>
	<set name="movie.imdb_id" value="${imdb_id[0][0]:htmldecode}"/>
	<retrieve name="imdb_details_page" url="http://www.imdb.com/title/${movie.imdb_id}"/>

    <!-- Title and Year -->
    <parse name="title" input="${details_page}" regex="${rx_title}"/>
	<parse name="year" input="${details_page}" regex="${rx_year}"/>
    <set name="movie.title" value="${title[0][0]:htmldecode}"/>
    <set name="movie.year" value="${year[0][0]:htmldecode}"/>

    <!-- Directors -->
    <parse name="directors_block" input="${details_page}" regex="${rx_directors_block}"/>
    <parse name="directors" input="${directors_block}" regex="${rx_director}"/>
    <set name='movie.directors' value=''/>
    <loop name='currDirector' on='directors'>
      <set name="movie.directors" value="${movie.directors}|${currDirector[0]:htmldecode}"/>
    </loop>

    <!-- Writers -->
    <parse name="writers_block" input="${imdb_details_page}" regex='&lt;div class="info"&gt;\s+&lt;h5&gt;Writer[s]?(?: &lt;a href="[^"]+"&gt;\([^)]+\)&lt;/a&gt;)?:&lt;/h5&gt;.+?&lt;/div&gt;'/>
    <parse name='writers' input="${writers_block}" regex='&lt;a href="/name/nm\d+/"&gt;([^&lt;]+)&lt;/a&gt;'/>
    <set name='movie.writers' value=''/>
    <loop name='currWriter' on='writers'>
      <set name='movie.writers' value='${movie.writers}|${currWriter[0]:htmldecode}'/>
    </loop>
	
    <!-- Actors -->
    <parse name="actors_block" input="${details_page}" regex="${rx_actors_block}"/>
    <parse name='actors' input="${actors_block}" regex="${rx_actor}"/>
    <set name='movie.actors' value=''/>
    <loop name='currActor' on='actors'>
      <set name='movie.actors' value='${movie.actors}|${currActor[0]:htmldecode}'/>
    </loop>

    <!-- Genres -->
    <parse name='genres' input="${details_page}" regex="${rx_genres}"/>
    <set name='movie.genres' value=''/>
    <loop name='currGenre' on='genres'>
      <set name='movie.genres' value='${movie.genres}|${currGenre[1]:htmldecode}'/>
    </loop>

    <!-- Certification -->
    <parse name="certification" input="${imdb_details_page}" regex='&gt;\s+USA:((?:G)|(?:PG)|(?:PG-13)|(?:R)|(?:X)|(?:NC-17))&lt;/a&gt;'/>
    <set name='movie.certification' value='${certification[0][0]:htmldecode}'/>
	
    <!-- Runtime -->
    <parse name="runtime" input="${imdb_details_page}" regex='&lt;h5&gt;Runtime:&lt;/h5&gt;.*?(\d+) min\s+'/>
    <set name='movie.runtime' value='${runtime[0][0]:htmldecode}'/>
    
    <!-- Score -->
    <parse name="score" input="${imdb_details_page}" regex='&lt;b&gt;(\d+.\d+)/10&lt;/b&gt; '/>
    <set name='movie.score' value='${score[0][0]:htmldecode}'/>
    
    <!-- Language -->
    <parse name="languages" input="${details_page}" regex="${rx_languages}"/>
    <set name='movie.language' value='${languages[0][1]:htmldecode}'/>
    
    <!-- Plot Summary -->
    <parse name="summary_block" input="${details_page}" regex="${rx_plot_block}"/>
    <parse name='summary' input="${summary_block[0][2]}" regex="${rx_plot}"/>
    <set name='movie.summary' value=''/>
    <loop name='currSummary' on='summary'>
      <set name='movie.summary' value='${movie.summary} ${currSummary[0]:htmldecode}'/>
    </loop>

    
	<!-- Set Sortby for Hebrew Titles -->
    <set name="movie.sortby" value="${movie.title}" />
    
  </action>

  <!-- Covert Art currently only works with the native site id -->
  <action name="get_cover_art">

    <if test="${movie.site_id}!=">

      <!-- Retrieve details -->
      <retrieve name="details_page" url="http://www.sratim.co.il/movies/view.aspx?id=${movie.site_id}"/>

      <!-- Regular Expressions-->	  
      <set name="rx_cover">
        <![CDATA[
		src="/movies/images/(.+?)"[\s]id=
		]]>
      </set>


	  <!-- Get cover source -->
	  <parse name="cover_src" input="${details_page}" regex="${rx_cover}"/>

	  <!-- set cover -->
	  <set name="cover_art[0].url" value="http://www.sratim.co.il/movies/images/${cover_src[0][0]}" />
    </if>
    
  </action>
  
</ScriptableScraper>
