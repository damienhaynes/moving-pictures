<?xml version="1.0" encoding="utf-8" ?>
<ScriptableScraper>

  <details>

    <!-- These details are for display purposes only. -->
    <name>CSFD.cz</name>
    <author>Trottel</author>
    <description>This script pulls data from CSFD and IMDb.</description>
    
    <!-- 
    These fields uniquely identify the script. The ID should never 
    change and should be unique (no other script should use this ID). With
    new versions of the script the version numbers should change. EVEN FOR 
    MINOR CHANGES, you should change the version number if you are going to
    distribute it to anyone but internal testers. The point number 
    is for minor bug fix releases. Use it.
    -->
    <id>874940</id>
    <version major="0" minor="1" point="9"/>
    <published month="6" day="28" year="2010"/>
    
    <!--
    These fields are used for categorization purposes. Seperate multiple 
    types with a pipe | character.
    -->
    <type>MovieDetailsFetcher</type>
    <language>cs</language>

  </details>
  
  <action name="search">
    
    <set name="offset" value="0" />

    <!-- Variables -->
    <set name="site" value="http://www.csfd.cz/" />
    
    <!-- Regular Expressions -->
    <set name="rx_details_site_id">
      <![CDATA[
      <script.*?>window.location.href='/film/(.+?)';</script>
      ]]>
    </set>

    <set name="rx_search_titles_years">
      <![CDATA[
      <title>(.+?)\s\((\d{4})\).*?</title>
      ]]>
    </set>

    <set name="rx_search_results_block">
      <![CDATA[
      >v originálních názvech</td>.+</body>
      ]]>
    </set>

    <set name="rx_verify">
      <![CDATA[
      &nbsp;&nbsp;&nbsp;<img.*?>&nbsp;&nbsp;<a href="/film/(.+?)"\s.*?">(.+?)</a>\s\((\d{4})\)
      ]]>
    </set>

    <set name="rx_search_site_id">
      <![CDATA[
      &nbsp;<a href="/film/(\d+.+?/)"\s.+?komentáře<br>
      ]]>
    </set>

    <!-- Retrieve results using Title -->
    <replace name="search.title" input="${search.title}" pattern="(^The\s+)|(^An?\s+)|(^De[rsmn]\s+)|(^Die\s+)|(^Das\s+)|(^Ein(e[srmn]?)?\s+)|(^El\s+)" with=""/>
    <retrieve name="search_page" url="${site}hledani-filmu-hercu-reziseru-ve-filmove-databazi/?search=${search.title:safe}" encoding="utf-8" retries="10" timeout_increment="3000" />

    <!-- If we got a details page, this is used. If not, regex does not match so we dont process the loop -->
    <parse name="site_id" input="${search_page}" regex="${rx_details_site_id}"/>
    <if test="${site_id[0][0]}!=">
      <retrieve name="details_page" url="${site}film/${site_id[0][0]}" encoding="utf-8" retries="10" timeout_increment="3000" allow_unsafe_header="true" />
      <parse name="title_year" input="${details_page}" regex="${rx_search_titles_years}"/>
      <set name="movie[0].title" value="${title_year[0][0]}" />
      <set name="movie[0].year" value="${title_year[0][1]}" />
      <set name="movie[0].site_id" value="${site_id[0][0]}" />
    </if>

    <!-- If we got a search result page, this is used. If not, regex does not match so we dont process the outer loop. -->
    <parse name="search_results_block" input="${search_page}" regex="${rx_search_results_block}"/>
    <if test="${search_results_block}!=">
      <loop name="search_results_verified" on="search_results_block">
        <parse name="movie_details" input="${search_results_verified}" regex="${rx_verify}" />
        <loop name="curr_details" on="movie_details" limit="20">
          <add name="counter" value1="${count}" value2="${offset}" />
          <parse name="title" input="${curr_details[1]:htmldecode}" regex="(.+?)(?:, (The|A|An|Ein|El|Das|Die|Der|Les|Un|Une))?$" />
          <set name="movie[${counter}].title" value="${title[0][1]} ${title[0][0]}" />
          <set name="movie[${counter}].year" value="${curr_details[2]:htmldecode}" />
          <set name="movie[${counter}].site_id" value="${curr_details[0]}" />
          <set name="movie[${counter}].details_url" value="${site}film/${curr_details[0]}"/>
          <subtract name="movie[${counter}].popularity" value1="100" value2="${counter}" />
        </loop>
      </loop>
    </if>
 
    <!-- This is ran if no movies were found on the first attempt.
         The intention here is to let the user use the CSFD.cz ID to find a movie. -->
    <if test="${movie[0].title}=">
      <retrieve name="search_page" url="${site}film/${search.title:safe}" regex="(\d+)" encoding="utf-8" retries="10" timeout_increment="3000" allow_unsafe_header="true" />
      <parse name="title_year" input="${search_page}" regex="${rx_search_titles_years}"/>
      <!-- makes sure a title was found on this page. If not there is no reason to ad anything else. -->
      <if test="${title_year[0][0]:htmldecode}!=">
        <set name="movie[0].title" value="${title_year[0][0]:htmldecode}" />
        <set name="movie[0].year" value="${title_year[0][1]:htmldecode}" />
        <parse name="site_id" input="${search_page}" regex="${rx_search_site_id}" />
        <set name="movie[0].site_id" value="${site_id[0][0]}" />
        <set name="movie[0].details_url" value="${site}film/${site_id[0][0]}" />
      </if>
    </if>

  </action>

  <action name="get_details">

    <!-- Only continue if we have a CSFD site id -->
    <if test="${movie.site_id}!=">

      <!-- Variables -->
      <set name="site" value="http://www.csfd.cz/film/" />

      <!-- Regular Expressions -->
      <set name="rx_title">
        <![CDATA[
        <h1.+?>\s*(?<movieTitle>.+?)(?:, (?<movieTitleArticle>The|A|An|Ein|El|Das|Der|Die|Les|Un|Une))?(?:\s/\s(?<movieAlternateTitle>.+?)(?:, (?<movieAlternateTitleArticle>The|A|An|Ein|El|Das|Der|Die|Les|Un|Une))?)?</h1>
        ]]>
      </set>

      <set name="rx_year">
        <![CDATA[
        <title>.*\((\d{4})\).*</title>
        ]]>
      </set>

      <set name="rx_akas">
        <![CDATA[
        vspace='2'\s></td><td>(.+?)(?:, (The|A|An|Ein|El|Das|Der|Die|Les|Un|Une))?</td></tr></table>
        ]]>
      </set>

      <set name="rx_directors_block">
        <![CDATA[
        <b>Režie:</b>\s(.*?)<br><b>Hrají:
        ]]>
      </set>

      <set name="rx_directors">
        <![CDATA[
        <a href="/reziser/[^>]+>([^<]+)</a>
        ]]>
      </set>

      <set name="rx_actors_block">
        <![CDATA[
        <b>Hrají:\s</b>.*?</div><br>&nbsp;<br></td>
        ]]>
      </set>

      <set name="rx_actors">
        <![CDATA[
        <a href="/herec/[^>]+>([^<]+)</a>
        ]]>
      </set>

      <set name="rx_genres_block">
        <![CDATA[
        <h1.*?>.+?</h1>.+<br><b>(.+?)&nbsp;<br>.+</b><BR><BR>
        ]]>
      </set>

      <set name="rx_score">
        <![CDATA[
        font-size:36px.+?>.*?(\d+)%.*?</td>
        ]]>
      </set>

      <set name="rx_votes">
        <![CDATA[
        >všechna&nbsp;hodnocení<br>\((\d+)\)</a></td>
        ]]>
      </set>

      <set name="rx_movie.site_id2">
        <![CDATA[
        title="Sdílet na Twitteru">.+?\&url=http://www.csfd.cz/film/(.+?)"
        ]]>
      </set>

      <set name="rx_plot">
        <![CDATA[
        <br>Obsah:.+?float:left.+?>(.+?)&nbsp;&nbsp;&nbsp;<b><i>
        ]]>
      </set>

      <set name="rx_plot2">
        <![CDATA[
        <br>Obsah:.+?float:left.+?>.+?&nbsp;\(<a href="(.+?)".+?\)
        ]]>
      </set>

      <set name="rx_writers_block">
	      <![CDATA[
	      <h5>Writer[s]?.*?<div class="info-content">.*?(.*?)</div>
	      ]]>
      </set>

      <set name="rx_language">
        <![CDATA[
        <a\shref="/Sections/Languages/[^/]+/">([^<]+)</a>
        ]]>
      </set>

	    <set name="rx_tagline">
        <![CDATA[
        <h5>Tagline.</h5>[^>]+>[^\r]?(?<movieTagline>[^<]+)
        ]]>
      </set>

      <!-- Retrieve details -->
      <set name="movie.details_url" value="${site}${movie.site_id}" />

      <retrieve name="details_page" url="${movie.details_url}" encoding="utf-8" retries="10" timeout_increment="3000" allow_unsafe_header="true" />

      <!-- Title -->
      <parse name="title" input="${details_page}" regex="${rx_title}" />
      <set name="movie.title" value="${title[0][1]} ${title[0][0]:htmldecode}" />

      <!-- Year -->
      <parse name="year" input="${details_page}" regex="${rx_year}" />
      <set name="movie.year" value="${year[0][0]}" />

      <!-- Alternate Title -->
      <parse name="akas" input="${details_page}" regex="${rx_akas}" />  
      <set name="movie.alternate_titles" value="${title[0][3]} ${title[0][2]}" />
      <loop name="currAka" on="akas">
        <set name="currAkaTemp" value='' />
        <if test="${currAka[1]}!=">
          <set name="currAkaTemp" value="${currAka[1]:htmldecode} " />
        </if>
        <set name="movie.alternate_titles" value="${movie.alternate_titles}|${currAkaTemp}${currAka[0]:htmldecode}" />
      </loop>

      <!-- Sort by Czech title -->
      <set name="movie.sortby" value="${movie.title}" />

      <!-- Directors -->
      <parse name="directors_block" input="${details_page}" regex="${rx_directors_block}" />
      <parse name="directors" input="${directors_block}" regex="${rx_directors}" />
      <set name='movie.directors' value='' />
      <loop name='currDirector' on='directors'>
        <set name="movie.directors" value="${movie.directors}|${currDirector[0]:htmldecode}" />
      </loop>
      <replace name="movie.directors" input="${movie.directors}" pattern="( )" with=" " />
      <replace name="movie.directors" input="${movie.directors}" pattern="(  )" with=" " />

      <!-- Actors -->
      <parse name="actors_block" input="${details_page}" regex="${rx_actors_block}"/>
      <parse name="actors" input="${actors_block}" regex="${rx_actors}" />
      <set name="movie.actors" value="" />
      <loop name="currActor" on="actors" limit="50">
        <set name="movie.actors" value="${movie.actors}|${currActor[0]:htmldecode}" />
      </loop>
      <replace name="movie.actors" input="${movie.actors}" pattern="( )" with=" " />
      <replace name="movie.actors" input="${movie.actors}" pattern="(  )" with=" " />

      <!-- Genres -->
      <parse name="genres_block" input="${details_page}" regex="${rx_genres_block}" />
      <parse name='genres' input='${genres_block[0][0]}' regex='([^/]+)'/>
      <set name='movie.genres' value=''/>
      <loop name='currGenre' on='genres'>
        <set name='movie.genres' value='${movie.genres}|${currGenre[0]:htmldecode}'/>
      </loop>

      <!-- Score -->
      <parse name="score" input="${details_page}" regex="${rx_score}" />
      <set name="movie.score" value="${score[0][0]:htmldecode}" />

      <!-- Popularity -->
      <parse name="votes" input="${details_page}" regex="${rx_votes}" />
      <set name="movie.popularity" value="${votes[0][0]:htmldecode}"/>

      <!-- Plot Summary -->
      <parse name="summary" input="${details_page}" regex="${rx_plot}"/>
      <set name="summary_clean" value="${summary[0][0]:striptags}" />
      <set name="movie.summary" value="${summary_clean:htmldecode}" />
    
      <!-- Plot Summary (if first method fails) -->
      <if test="${movie.summary}=">
      <parse name="summary_id" input="${details_page}" regex="${rx_plot2}" />
      <set name="movie.summary_id" value="${summary_id[0][0]}" />      
      <parse name="movie.site_id2" input="${details_page}" regex="${rx_movie.site_id2}" />
      <retrieve name="summary_page" url="${site}${movie.site_id2[0][0]}${movie.summary_id}" encoding="utf-8" retries="10" timeout_increment="3000" allow_unsafe_header="true" />
        <parse name="summary2" input="${summary_page}" regex="${rx_plot}"/>
        <set name="summary_clean" value="${summary2[0][0]:striptags}" />
        <set name="movie.summary" value="${summary_clean:htmldecode}" />
      </if>

      <!-- IMDb ID -->
      <parse name="imdb" input="${details_page}" regex="(tt[\d]+)" />
      <set name="movie.imdb_id" value="${imdb[0][0]}" />

      <!-- Retrieve other details from IMDb -->
      <if test="${movie.imdb_id}!=">
        <retrieve name="imdb_details_page" url="http://www.imdb.com/title/${movie.imdb_id}" retries="10" timeout_increment="3000" />

        <!-- IMDb ID -->
        <parse name="imdb" input="${imdb_details_page}" regex='&lt;link rel="canonical" href="http://www.imdb.com/title/(tt[\d]{7})/" /&gt;' />
        <set name="movie.imdb_id" value="${imdb[0][0]}" />

        <!-- Writers -->
        <parse name="writers_block" input="${imdb_details_page}" regex="${rx_writers_block}" />
        <parse name='writers' input="${writers_block}" regex='&lt;a href="/name/nm\d+/"[^&gt;]*&gt;([^&lt;]+)&lt;/a&gt;'/>
        <set name='movie.writers' value=''/>
        <loop name='currWriter' on='writers'>
          <set name='movie.writers' value='${movie.writers}|${currWriter[0]:htmldecode}'/>
        </loop>

        <!-- Certification -->
        <parse name="certification" input="${imdb_details_page}" regex='&gt;UK:((?:U)|(?:PG)|(?:12)|(?:12A)|(?:15)|(?:18)|(?:R18))&lt;/a&gt;'/>
        <set name='movie.certification' value='${certification[0][0]:htmldecode}'/>

        <replace name="movie.certification" input="${movie.certification}" pattern="(U)" with="Pro všechny věkové skupiny" />
        <replace name="movie.certification" input="${movie.certification}" pattern="(PG)" with="Doprovod rodiče" />
        <replace name="movie.certification" input="${movie.certification}" pattern="(12)" with="Přístupné od 12 let" />
        <replace name="movie.certification" input="${movie.certification}" pattern="(Přístupné od 12 letA)" with="Vhodné od 12 let" />
        <replace name="movie.certification" input="${movie.certification}" pattern="(15)" with="Přístupné od 15 let" />
        <replace name="movie.certification" input="${movie.certification}" pattern="(18)" with="Přístupné od 18 let" />
        <replace name="movie.certification" input="${movie.certification}" pattern="(RPřístupné od 18 let)" with="Zakázaný film" />

        <if test="${movie.certification}=">
          <set name='movie.certification' value='Neuvedeno'/>
        </if>
        
        <!-- Runtime -->
        <parse name="runtime" input="${imdb_details_page}" regex='&lt;h5&gt;Runtime:&lt;/h5&gt;.*?(\d+) min\s+'/>
        <set name='movie.runtime' value='${runtime[0][0]:htmldecode}'/>

        <!-- Tagline -->
        <parse name="tagline" input="${imdb_details_page}" regex="${rx_tagline}" />
        <set name='movie.tagline' value='${tagline[0][0]:htmldecode}'/>

        <!-- Language (only first match) -->
        <parse name="language" input="${imdb_details_page}" regex="${rx_language}" />
        <set name='movie.language' value='${language[0][0]:htmldecode}'/>

        <replace name="movie.language" input="${movie.language}" pattern="(Cantonese)" with="Kantonsky" />
        <replace name="movie.language" input="${movie.language}" pattern="(Czech)" with="Česky" />
        <replace name="movie.language" input="${movie.language}" pattern="(Danish)" with="Dánsky" />
        <replace name="movie.language" input="${movie.language}" pattern="(Dutch)" with="Nizozemsky" />
        <replace name="movie.language" input="${movie.language}" pattern="(English)" with="Anglicky" />
        <replace name="movie.language" input="${movie.language}" pattern="(Estonian)" with="Estonsky" />
        <replace name="movie.language" input="${movie.language}" pattern="(Filipino)" with="Filipínsky" />
        <replace name="movie.language" input="${movie.language}" pattern="(Finish)" with="Finsky" />
        <replace name="movie.language" input="${movie.language}" pattern="(French)" with="Francouzsky" />
        <replace name="movie.language" input="${movie.language}" pattern="(German)" with="Německy" />
        <replace name="movie.language" input="${movie.language}" pattern="(Hindi)" with="Hindsky" />
        <replace name="movie.language" input="${movie.language}" pattern="(Icelandic)" with="Islandsky" />
        <replace name="movie.language" input="${movie.language}" pattern="(Italian)" with="Italsky" />
        <replace name="movie.language" input="${movie.language}" pattern="(Japanese)" with="Japonsky" />
        <replace name="movie.language" input="${movie.language}" pattern="(Korean)" with="Korejsky" />
        <replace name="movie.language" input="${movie.language}" pattern="(Mandarin)" with="Mandarínsky" />
        <replace name="movie.language" input="${movie.language}" pattern="(Mongolian)" with="Mongolsky" />
        <replace name="movie.language" input="${movie.language}" pattern="(Norwegian)" with="Norsky" />
        <replace name="movie.language" input="${movie.language}" pattern="(Portuguese)" with="Portugalsky" />
        <replace name="movie.language" input="${movie.language}" pattern="(Russian)" with="Rusky" />
        <replace name="movie.language" input="${movie.language}" pattern="(Saami)" with="Laponsky" />
        <replace name="movie.language" input="${movie.language}" pattern="(Spanish)" with="Španělsky" />
        <replace name="movie.language" input="${movie.language}" pattern="(Swedish)" with="Švédsky" />
        <replace name="movie.language" input="${movie.language}" pattern="(Tamil)" with="Tamilsky" />

      </if>

    </if>
   
  </action>
  
</ScriptableScraper>